<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ops Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f5f6fa; }
        .card { transition: 0.2s; cursor: pointer; }
        .card:hover { transform: scale(1.02); }
        #modal { display:none; }
    </style>
</head>

<body class="p-6">

    <!-- Loader -->
    <div id="loader" class="text-center text-xl font-semibold">Loading...</div>

    <!-- Cards -->
    <div id="cardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6"></div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 md:w-1/2">
            <div class="flex justify-between items-center mb-3">
                <h2 id="modalTitle" class="text-xl font-bold"></h2>
                <button onclick="closeModal()" class="text-red-500 font-bold text-xl">&times;</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5">
                <div>Total Inquiries: <span id="mInq" class="font-bold"></span></div>
                <div>Total Count: <span id="mCount" class="font-bold"></span></div>
                <div>Missed Reply: <span id="mReply" class="font-bold"></span></div>
                <div>Missed Order: <span id="mOrder" class="font-bold"></span></div>
                <div>Missed Update: <span id="mUpdate" class="font-bold"></span></div>
                <div>Wrong Reply: <span id="mWrong" class="font-bold"></span></div>
            </div>

            <canvas id="modalChart" height="120"></canvas>
        </div>
    </div>


<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzTIupkSmRxfyGJuDsktonVW015RkXjSRfs-Ufd5aDmSKD85bMCnfY8pWSxzU9wBHHw/exec";

let modalChart = null;

window.onload = () => {
    fetch(API_URL)
        .then(r => r.json())
        .then(data => {
            loadDashboard(data);
            document.getElementById("loader").style.display = "none";
        })
        .catch(err => {
            console.error("API Error:", err);
            document.getElementById("loader").innerText = "Failed to load data";
        });
};

function loadDashboard(data) {
    const monthly = data.monthlyData || [];
    const daily = data.dailyData || [];

    const safe = v => Number(v || 0);

    // Map daily by assignee
    const dailyMap = {};
    daily.forEach(d => dailyMap[d.assignee] = d);

    monthly.forEach(m => {
        const d = dailyMap[m.assignee] || {
            totalCount: 0,
            missedReply: 0,
            missedOrder: 0,
            missedUpdate: 0,
            wrongReply: 0
        };

        createCard({
            zone: m.zone,
            assignee: m.assignee,
            totalInquiries: safe(m.totalInquiries),
            totalCount: safe(d.totalCount),
            missedReply: safe(d.missedReply),
            missedOrder: safe(d.missedOrder),
            missedUpdate: safe(d.missedUpdate),
            wrongReply: safe(d.wrongReply)
        });
    });
}

function createCard(obj) {
    const card = document.createElement("div");
    card.className = "card p-4 bg-white shadow rounded-lg";
    card.onclick = () => openModal(obj);

    card.innerHTML = `
        <h3 class="text-lg font-bold">${obj.zone}</h3>
        <p class="text-sm text-gray-600">${obj.assignee}</p>
        <div class="mt-3">
            <div>Total Inquiries: <b>${obj.totalInquiries}</b></div>
            <div>Total Count: <b>${obj.totalCount}</b></div>
        </div>
    `;

    document.getElementById("cardContainer").appendChild(card);
}

function openModal(d) {
    document.getElementById("modalTitle").innerText = d.zone + " â€” " + d.assignee;
    document.getElementById("mInq").innerText = d.totalInquiries;
    document.getElementById("mCount").innerText = d.totalCount;
    document.getElementById("mReply").innerText = d.missedReply;
    document.getElementById("mOrder").innerText = d.missedOrder;
    document.getElementById("mUpdate").innerText = d.missedUpdate;
    document.getElementById("mWrong").innerText = d.wrongReply;

    if (modalChart) modalChart.destroy();

    modalChart = new Chart(document.getElementById("modalChart"), {
        type: "bar",
        data: {
            labels: ["Missed Reply", "Missed Order", "Missed Update", "Wrong Reply"],
            datasets: [{
                label: "Count",
                data: [
                    d.missedReply,
                    d.missedOrder,
                    d.missedUpdate,
                    d.wrongReply
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });

    document.getElementById("modal").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}
</script>

</body>
</html>
